name: E2E Maestro Tests

on:
  workflow_call:
    inputs:
      platform:
        description: 'Target platform (android/ios)'
        required: false
        type: string
        default: 'android'
      app-artifact:
        description: 'Name of the app artifact to download (APK for Android, .app.zip for iOS)'
        required: true
        type: string
      suites:
        description: 'JSON array of test suites to run'
        required: true
        type: string
    secrets:
      QUITOQUE_USERNAME:
        required: false
      QUITOQUE_PASSWORD:
        required: false

jobs:
  e2e-tests:
    name: E2E ${{ inputs.platform }} (${{ matrix.suite }})
    runs-on: ${{ inputs.platform == 'ios' && 'macos-15-intel' || 'ubuntu-latest' }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        suite: ${{ fromJson(inputs.suites) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Setup Java 17 for Maestro
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ============================================
      # Android Setup
      # ============================================
      - name: Setup Android SDK
        if: inputs.platform == 'android'
        uses: android-actions/setup-android@v3

      - name: Download APK
        if: inputs.platform == 'android'
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.app-artifact }}

      - name: Enable KVM
        if: inputs.platform == 'android'
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup Maestro CLI (Android)
        if: inputs.platform == 'android'
        uses: dniHze/maestro-test-action@v1
        with:
          version: '2.0.10'

      - name: Run E2E tests (Android)
        if: inputs.platform == 'android'
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          profile: Nexus 5
          emulator-options: -no-snapshot -no-window -noaudio -no-boot-anim -wipe-data -memory 4096 -cores 4
          script: bash .github/scripts/run-e2e-android.sh ${{ matrix.suite }}
        env:
          QUITOQUE_USERNAME: ${{ secrets.QUITOQUE_USERNAME }}
          QUITOQUE_PASSWORD: ${{ secrets.QUITOQUE_PASSWORD }}

      # ============================================
      # iOS Setup
      # ============================================
      - name: Download iOS app
        if: inputs.platform == 'ios'
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.app-artifact }}

      - name: Unzip iOS app bundle
        if: inputs.platform == 'ios'
        run: |
          unzip -q *.zip
          rm -f *.zip
          echo "üì± iOS app bundle extracted"
          ls -la *.app || echo "No .app found at root level"

      - name: Boot iOS Simulator
        if: inputs.platform == 'ios'
        id: simulator
        uses: futureware-tech/simulator-action@v4
        with:
          model: 'iPhone SE (3rd generation)'
          os_version: '18.6'
          wait_for_boot: true
          erase_before_boot: false
          shutdown_after_job: true

      - name: Disable hardware keyboard
        if: inputs.platform == 'ios'
        run: |
          echo "‚å®Ô∏è Disabling hardware keyboard for software keyboard to appear..."
          defaults write com.apple.iphonesimulator ConnectHardwareKeyboard -bool NO
          echo "‚úÖ Hardware keyboard disabled"

      - name: Setup Maestro CLI (iOS)
        if: inputs.platform == 'ios'
        uses: dniHze/maestro-test-action@v1
        with:
          version: '2.0.10'

      - name: Run E2E tests (iOS)
        if: inputs.platform == 'ios'
        env:
          MAESTRO_DRIVER_STARTUP_TIMEOUT: 360000
          QUITOQUE_USERNAME: ${{ secrets.QUITOQUE_USERNAME }}
          QUITOQUE_PASSWORD: ${{ secrets.QUITOQUE_PASSWORD }}
        run: bash .github/scripts/run-e2e-ios.sh ${{ matrix.suite }}

      - name: Collect iOS app log file
        if: always() && inputs.platform == 'ios'
        run: bash .github/scripts/collect-ios-logs.sh ${{ matrix.suite }} ${{ steps.simulator.outputs.udid }}

      # ============================================
      # Common: Logs and Artifacts
      # ============================================
      - name: Prepare suite logs
        if: always()
        run: bash .github/scripts/prepare-maestro-logs.sh maestro_logs_${{ matrix.suite }}

      - name: Upload test suite logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: maestro-logs-${{ inputs.platform }}-${{ matrix.suite }}.zip
          path: maestro_logs_${{ matrix.suite }}/
          retention-days: 1

      - name: Upload JUnit report for suite
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: junit-e2e-${{ inputs.platform }}-${{ matrix.suite }}
          path: report.xml
          retention-days: 1
