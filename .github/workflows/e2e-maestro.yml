name: E2E Maestro Tests

on:
  workflow_call:
    inputs:
      platform:
        description: 'Target platform (android/ios)'
        required: false
        type: string
        default: 'android'
      app-artifact:
        description: 'Name of the app artifact to download (APK for Android, .app.zip for iOS)'
        required: true
        type: string
      suites:
        description: 'JSON array of test suites to run'
        required: true
        type: string
    secrets:
      QUITOQUE_USERNAME:
        required: false
      QUITOQUE_PASSWORD:
        required: false

jobs:
  e2e-tests:
    name: E2E ${{ inputs.platform }} (${{ matrix.suite }})
    runs-on: ${{ inputs.platform == 'ios' && 'macos-15-intel' || 'ubuntu-latest' }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        suite: ${{ fromJson(inputs.suites) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Setup Java 17 for Maestro
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ============================================
      # Android Setup
      # ============================================
      - name: Setup Android SDK
        if: inputs.platform == 'android'
        uses: android-actions/setup-android@v3

      - name: Download APK
        if: inputs.platform == 'android'
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.app-artifact }}

      - name: Enable KVM
        if: inputs.platform == 'android'
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Setup Maestro CLI (Android)
        if: inputs.platform == 'android'
        uses: dniHze/maestro-test-action@v1
        with:
          version: '2.0.10'

      - name: Run E2E tests (Android)
        if: inputs.platform == 'android'
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          profile: Nexus 5
          emulator-options: -no-snapshot -no-window -noaudio -no-boot-anim -wipe-data -memory 4096 -cores 4
          script: |
            sleep 10
            echo "ðŸ”„ Waiting for device..."
            adb wait-for-device

            # Clear logcat before test
            adb logcat -c

            echo "ðŸš€ Running E2E tests on suite: ${{ matrix.suite }} ..."
            npm run install:android
            TEST_EXIT_CODE=0
            maestro test tests/e2e/ --config=tests/e2e/${{ matrix.suite }}.yaml --debug-output=maestro_logs_${{ matrix.suite }} --format junit -s 1 -e QUITOQUE_USERNAME='${{ secrets.QUITOQUE_USERNAME }}' -e QUITOQUE_PASSWORD='${{ secrets.QUITOQUE_PASSWORD }}' || TEST_EXIT_CODE=$?

            # Dump logcat to file after test
            echo "ðŸ“‹ Collecting Android logs..."
            adb logcat -d > maestro_logs_${{ matrix.suite }}/android-app-logs.txt 2>&1
            echo "ðŸ“‹ Android logs collected ($(wc -l < maestro_logs_${{ matrix.suite }}/android-app-logs.txt) lines)"

            exit $TEST_EXIT_CODE

      # ============================================
      # iOS Setup
      # ============================================
      - name: Download iOS app
        if: inputs.platform == 'ios'
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.app-artifact }}

      - name: Unzip iOS app bundle
        if: inputs.platform == 'ios'
        run: |
          unzip -q *.zip
          rm -f *.zip
          echo "ðŸ“± iOS app bundle extracted"
          ls -la *.app || echo "No .app found at root level"

      - name: Boot iOS Simulator
        if: inputs.platform == 'ios'
        id: simulator
        uses: futureware-tech/simulator-action@v4
        with:
          model: 'iPhone SE (3rd generation)'
          wait_for_boot: true
          erase_before_boot: false
          shutdown_after_job: true

      - name: Setup Maestro CLI (iOS)
        if: inputs.platform == 'ios'
        uses: dniHze/maestro-test-action@v1
        with:
          version: '2.0.10'

      - name: Run E2E tests (iOS)
        if: inputs.platform == 'ios'
        env:
          MAESTRO_DRIVER_STARTUP_TIMEOUT: 180000
        run: |
          echo "ðŸš€ Running E2E tests on iOS simulator for suite: ${{ matrix.suite }} ..."
          echo "ðŸ“± Using simulator UDID: ${{ steps.simulator.outputs.udid }}"
          npm run install:ios
          maestro test tests/e2e/ \
            --config=tests/e2e/${{ matrix.suite }}.yaml \
            --debug-output=maestro_logs_${{ matrix.suite }} \
            --format junit -s 1 \
            -e QUITOQUE_USERNAME='${{ secrets.QUITOQUE_USERNAME }}' \
            -e QUITOQUE_PASSWORD='${{ secrets.QUITOQUE_PASSWORD }}'

      - name: Collect iOS logs
        if: always() && inputs.platform == 'ios'
        run: |
          echo "ðŸ“‹ Collecting iOS logs..."
          mkdir -p maestro_logs_${{ matrix.suite }}
          xcrun simctl spawn ${{ steps.simulator.outputs.udid }} log show \
            --predicate 'subsystem CONTAINS "com.recipedia" OR process CONTAINS "Recipedia"' \
            --style compact \
            --last 1h > maestro_logs_${{ matrix.suite }}/ios-app-logs.txt 2>&1 || true
          echo "ðŸ“‹ iOS logs collected ($(wc -l < maestro_logs_${{ matrix.suite }}/ios-app-logs.txt 2>/dev/null || echo 0) lines)"

      # ============================================
      # Common: Logs and Artifacts
      # ============================================
      - name: Prepare suite logs
        if: always()
        run: bash .github/scripts/prepare-maestro-logs.sh maestro_logs_${{ matrix.suite }}

      - name: Upload test suite logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: maestro-logs-${{ inputs.platform }}-${{ matrix.suite }}
          path: maestro_logs_${{ matrix.suite }}.zip
          retention-days: 1

      - name: Upload JUnit report for suite
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: junit-e2e-${{ inputs.platform }}-${{ matrix.suite }}
          path: report.xml
          retention-days: 1
