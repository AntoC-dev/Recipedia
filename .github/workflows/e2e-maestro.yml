name: E2E Maestro Tests

on:
  workflow_call:
    inputs:
      platform:
        description: 'Target platform (android/ios)'
        required: false
        type: string
        default: 'android'
      app-artifact:
        description: 'Name of the app artifact to download (APK for Android, .app.zip for iOS)'
        required: true
        type: string
      suites:
        description: 'JSON array of test suites to run'
        required: true
        type: string
    secrets:
      QUITOQUE_USERNAME:
        required: false
      QUITOQUE_PASSWORD:
        required: false

jobs:
  e2e-tests:
    name: E2E ${{ inputs.platform }} (${{ matrix.suite }})
    runs-on: ${{ inputs.platform == 'ios' && 'macos-latest' || 'ubuntu-latest' }}
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        suite: ${{ fromJson(inputs.suites) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: '22'

      # Android setup
      - name: Setup Maestro environment (Android)
        if: inputs.platform == 'android'
        uses: ./.github/actions/setup-maestro
        with:
          apk-artifact: ${{ inputs.app-artifact }}

      # iOS setup
      - name: Setup Maestro environment (iOS)
        if: inputs.platform == 'ios'
        uses: ./.github/actions/setup-maestro-ios
        with:
          app-artifact: ${{ inputs.app-artifact }}

      # Android E2E execution
      - name: Run E2E tests (Android)
        if: inputs.platform == 'android'
        uses: ReactiveCircus/android-emulator-runner@v2
        with:
          api-level: 34
          target: google_apis
          arch: x86_64
          profile: Nexus 5
          emulator-options: -no-snapshot -no-window -noaudio -no-boot-anim -wipe-data -memory 4096 -cores 4
          script: |
            sleep 10
            echo "ðŸ”„ Waiting for device..."
            adb wait-for-device

            echo "ðŸš€ Running E2E tests on suite: ${{ matrix.suite }} ..."
            npm run install:android
            maestro test tests/e2e/ --config=tests/e2e/${{ matrix.suite }}.yaml --debug-output=maestro_logs_${{ matrix.suite }} --format junit -s 1 -e QUITOQUE_USERNAME='${{ secrets.QUITOQUE_USERNAME }}' -e QUITOQUE_PASSWORD='${{ secrets.QUITOQUE_PASSWORD }}'

      # iOS E2E execution
      - name: Run E2E tests (iOS)
        if: inputs.platform == 'ios'
        run: |
          echo "ðŸš€ Running E2E tests on iOS simulator for suite: ${{ matrix.suite }} ..."
          npm run install:ios
          maestro test tests/e2e/ --config=tests/e2e/${{ matrix.suite }}.yaml --debug-output=maestro_logs_${{ matrix.suite }} --format junit -s 1 -e QUITOQUE_USERNAME='${{ secrets.QUITOQUE_USERNAME }}' -e QUITOQUE_PASSWORD='${{ secrets.QUITOQUE_PASSWORD }}'

      - name: Prepare suite logs
        if: always()
        run: bash .github/scripts/prepare-maestro-logs.sh maestro_logs_${{ matrix.suite }}

      - name: Upload test suite logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: maestro-logs-${{ inputs.platform }}-${{ matrix.suite }}
          path: maestro_logs_${{ matrix.suite }}.zip
          retention-days: 1

      - name: Upload JUnit report for suite
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: junit-e2e-${{ inputs.platform }}-${{ matrix.suite }}
          path: report.xml
          retention-days: 1
