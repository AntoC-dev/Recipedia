name: Build & Test Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write
  actions: read

jobs:
  install-and-doctor:
    name: Install Dependencies and run Expo doctor
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'
      - run: npm ci
      - name: Cache node modules
        uses: actions/cache/save@v5
        with:
          path: node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('package-lock.json') }}



  reassure-performance:
    name: Reassure Performance Tests
    runs-on: ubuntu-latest
    needs: install-and-doctor
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Restore node modules
        uses: actions/cache/restore@v5
        with:
          path: node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('package-lock.json') }}

      - uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Run Reassure performance tests
        if: github.event_name == 'pull_request'
        run: npm run test:perf

      - name: Post Reassure results on PR
        if: github.event_name == 'pull_request' && hashFiles('.reassure/output.md') != ''
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: reassure
          path: .reassure/output.md

      - name: Upload Reassure output
        uses: actions/upload-artifact@v5
        with:
          name: reassure-output
          path: .reassure/
          retention-days: 7
          if-no-files-found: warn

  unit-tests-and-coverage:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    needs: install-and-doctor
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Restore node modules
        uses: actions/cache/restore@v5
        with:
          path: node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('package-lock.json') }}

      - uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Run tests with coverage
        run: npm run test:unit:coverage

      - name: Unit tests summary
        uses: test-summary/action@v2
        with:
          paths: junit.xml
          output: unit-test-summary.md
        if: always()

      - name: Upload unit tests summary
        uses: actions/upload-artifact@v5
        with:
          name: unit-test-summary
          path: unit-test-summary.md
        if: always()

      - name: Upload coverage reports
        uses: actions/upload-artifact@v5
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 30

      - name: Coverage report for changed files
        uses: 5monkeys/cobertura-action@master
        with:
          path: coverage/cobertura-coverage.xml
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          minimum_coverage: 75
          fail_below_threshold: false
          show_missing: false
          show_line: true
          show_branch: true
          show_class_names: false
          only_changed_files: true
        if: github.event_name == 'pull_request'

  build-android:
    name: Build Android APK
    needs: install-and-doctor
    uses: ./.github/workflows/build-app.yml
    with:
      platform: android
      build-profile: test
      artifact-name: build-apk
      app-filename: recipedia-maestro.apk
    secrets:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  build-android-performance:
    name: Build Android APK (Performance)
    needs: install-and-doctor
    uses: ./.github/workflows/build-app.yml
    with:
      platform: android
      build-profile: perf
      artifact-name: build-apk-performance
      app-filename: recipedia-performance.apk
    secrets:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  build-ios:
    name: Build iOS App
    needs: install-and-doctor
    uses: ./.github/workflows/build-app.yml
    with:
      platform: ios
      build-profile: test
      artifact-name: build-ios-app
      app-filename: Recipedia.app
    secrets:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  build-ios-performance:
    name: Build iOS App (Performance)
    needs: install-and-doctor
    uses: ./.github/workflows/build-app.yml
    with:
      platform: ios
      build-profile: perf
      artifact-name: build-ios-app-performance
      app-filename: Recipedia-performance.app
    secrets:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  e2e-tests-android:
    name: E2E Tests (Android)
    needs: build-android
    uses: ./.github/workflows/e2e-maestro.yml
    with:
      platform: android
      app-artifact: build-apk
      suites: '["app-init", "search", "recipe-view", "recipe-create", "shopping", "menu", "settings", "tags-db", "ingredients-db", "duplicates-tag", "duplicates-ingredient", "duplicates-recipe", "ocr", "web-edge-cases", "web", "bulk-import"]'
    secrets:
      QUITOQUE_USERNAME: ${{ secrets.QUITOQUE_USERNAME }}
      QUITOQUE_PASSWORD: ${{ secrets.QUITOQUE_PASSWORD }}

  e2e-tests-android-performance:
    name: E2E Tests Android (Performance)
    needs: build-android-performance
    uses: ./.github/workflows/e2e-maestro.yml
    with:
      platform: android
      app-artifact: build-apk-performance
      suites: '["performance"]'

  e2e-tests-ios:
    name: E2E Tests (iOS)
    needs: build-ios
    uses: ./.github/workflows/e2e-maestro.yml
    with:
      platform: ios
      app-artifact: build-ios-app
      suites: '["app-init", "search", "recipe-view", "recipe-create", "shopping", "settings", "tags-db", "ingredients-db", "duplicates-tag", "duplicates-ingredient", "duplicates-recipe", "ocr", "web-edge-cases", "web", "bulk-import"]'
    secrets:
      QUITOQUE_USERNAME: ${{ secrets.QUITOQUE_USERNAME }}
      QUITOQUE_PASSWORD: ${{ secrets.QUITOQUE_PASSWORD }}

  e2e-tests-ios-performance:
    name: E2E Tests iOS (Performance)
    needs: build-ios-performance
    uses: ./.github/workflows/e2e-maestro.yml
    with:
      platform: ios
      app-artifact: build-ios-app-performance
      suites: '["performance"]'

  merge-test-artifacts:
    name: Merge E2E Test Artifacts
    if: always()
    runs-on: ubuntu-latest
    needs: [ e2e-tests-android, e2e-tests-android-performance, e2e-tests-ios, e2e-tests-ios-performance ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Restore node modules
        uses: actions/cache/restore@v5
        with:
          path: node_modules
          key: ${{ runner.os }}-node_modules-${{ hashFiles('package-lock.json') }}

      - uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: Download all E2E JUnit reports
        if: always()
        uses: actions/download-artifact@v7
        with:
          pattern: junit-e2e-*
          path: junit-reports
          merge-multiple: false

      - name: Download Android Maestro logs
        if: always()
        uses: actions/download-artifact@v7
        with:
          pattern: maestro-logs-android-*
          path: maestro-logs-android
          merge-multiple: false

      - name: Download iOS Maestro logs
        if: always()
        uses: actions/download-artifact@v6
        with:
          pattern: maestro-logs-ios-*
          path: maestro-logs-ios
          merge-multiple: false

      - name: Merge JUnit reports
        if: always()
        run: |
          mkdir -p merged-reports
          npx jrm merged-reports/report.xml "junit-reports/**/*.xml"

      - name: Package Android Maestro logs
        if: always()
        run: bash .github/scripts/merge-maestro-logs.sh maestro-logs-android maestro-logs-android.zip

      - name: Package iOS Maestro logs
        if: always()
        run: bash .github/scripts/merge-maestro-logs.sh maestro-logs-ios maestro-logs-ios.zip

      - name: Delete individual suite artifacts
        if: always()
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            junit-e2e-*
            maestro-logs-android-*
            maestro-logs-ios-*
          failOnError: false

      - name: Upload merged JUnit report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-junit-merged
          path: merged-reports/report.xml
          retention-days: 7

      - name: Upload Android Maestro logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: maestro-logs-android
          path: maestro-logs-android.zip
          retention-days: 7

      - name: Upload iOS Maestro logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: maestro-logs-ios
          path: maestro-logs-ios.zip
          retention-days: 7

  test-result-summary:
    name: Generate Test Result Summary
    if: always()
    runs-on: ubuntu-latest
    needs: [ merge-test-artifacts, unit-tests-and-coverage ]
    steps:
      - name: Download unit test results
        if: always()
        uses: actions/download-artifact@v7
        with:
          name: unit-test-summary

      - name: Download merged E2E JUnit report
        if: always()
        continue-on-error: true
        uses: actions/download-artifact@v7
        with:
          name: e2e-junit-merged
          path: e2e-reports

      - name: Generate E2E test summary
        uses: test-summary/action@v2
        with:
          paths: e2e-reports/report.xml
          output: e2e-summary.md
        if: always()
        continue-on-error: true

      - name: Combine test summaries
        if: always()
        run: |
          echo "### ðŸ§ª CI Test Results Summary" > full-summary.md
          echo "" >> full-summary.md
          echo "#### ðŸ§© Unit Tests" >> full-summary.md
          echo "" >> full-summary.md
          if [ -f unit-test-summary.md ]; then
            cat unit-test-summary.md >> full-summary.md
          else
            echo "âš ï¸ Unit test results not available" >> full-summary.md
          fi
          echo "" >> full-summary.md
          echo "#### ðŸ“± E2E Tests (Android + iOS)" >> full-summary.md
          echo "" >> full-summary.md
          if [ -f e2e-summary.md ]; then
            cat e2e-summary.md >> full-summary.md
          else
            echo "âš ï¸ E2E test results not available" >> full-summary.md
          fi
          echo "" >> full-summary.md
          echo "_ðŸ“Š Coverage for changed files is posted in a separate comment. View merged logs in the Actions tab._" >> full-summary.md

      - name: Comment test summary on PR
        uses: marocchino/sticky-pull-request-comment@v2
        if: always()
        with:
          path: full-summary.md
