appId: "com.recipedia"
---
# Verifies that the Android gallery picker has indexed all expected images
# Uses modalImageCounter to determine how many thumbnails should exist
# Retries up to 10 times with 500ms delays if thumbnails aren't ready
# Closes and reopens gallery between attempts to force refresh
# TODO: Implement iOS version in ../iOS/waitAndVerifyGalleryReady.yaml

# Determine expected thumbnail index to check
# If modalImageCounter is not set (first image), check index 0
# If modalImageCounter = N, check index N (means N+1 total images expected)
- evalScript: ${output.expectedThumbnailIndex = output.modalImageCounter ?? 0}
- evalScript: ${output.galleryReady = false}
- evalScript: ${output.retryCount = 0}

# Attempt to find thumbnail at expected index
- runFlow:
    when:
      visible:
        id: "icon_thumbnail"
        index: ${output.expectedThumbnailIndex}
    commands:
      - evalScript: ${output.galleryReady = true}
    label: "Check if thumbnail at index ${output.expectedThumbnailIndex} exists"

# Retry up to 10 times if not found
- repeat:
    while:
      true: ${!output.galleryReady && output.retryCount < 10}
    commands:
      - evalScript: ${output.retryCount = output.retryCount + 1}

      - pressKey: "BACK"

      - runFlow:
          when:
            visible:
              id: "Modal::Gallery::RoundButton"
          commands:
            - tapOn:
                id: "Modal::Gallery::RoundButton"
                label: "Reopen gallery"

      - runFlow:
          when:
            visible:
              id: "ExpandButton"
          commands:
            - runFlow:
                file: "../../../../fab/expand.yaml"
                label: "Expand FAB menu"
            - tapOn:
                id: "GalleryButton"
                label: "Reopen gallery"

      - runFlow:
          when:
            visible:
              id: "icon_thumbnail"
              index: ${output.expectedThumbnailIndex}
          commands:
            - evalScript: ${output.galleryReady = true}
